<!doctype html><html lang=en><head><meta charset=utf-8><meta content=public http-equiv=Cache-control><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1,maximum-scale=5" name=viewport><title>Varnish For Static Sites | OhDoyleRules</title><meta content="Varnish For Static Sites | OhDoyleRules" name=twitter:title><meta content=KM-5h_iJ7JJsGeUp4ncEoYCBKft1ko1A4gBpjIzT0p4 name=google-site-verification><meta content="Varnish For Static Sites" itemprop=name><meta content=OhDoyleRules property=og:site_name><meta content=https://ohdoylerules.com/web/varnish-for-static-sites/ itemprop=url><meta content=james2doyle@gmail.com itemprop=email><meta content=https://ohdoylerules.com/web/varnish-for-static-sites/ property=og:url><meta itemprop="image logo" content=/icons/logo.png><meta content=/icons/logo.png property=og:image><link href=/icons/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><link href=/icons/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/icons/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/site.webmanifest rel=manifest><link color=#333333 href=/icons/safari-pinned-tab.svg rel=mask-icon><link href=/icons/favicon.ico rel=icon sizes=any><link href=/icons/favicon.svg rel=icon type=image/svg+xml><meta content=/browserconfig.xml name=msapplication-config><meta content=#ffffff name=msapplication-TileColor><meta content=#ffffff name=theme-color><meta content=summary name=twitter:card><meta content=@james2doyle name=twitter:site><meta content="Varnish For Static Sites" name=twitter:title><meta content=@james2doyle name=twitter:creator><meta content=/icons/logo.png name=twitter:image><meta content=/ name=twitter:domain><link href=/icons/logo.svg rel=icon><meta content="a small tutorial for how to setup Varnish cache for a flat site running on Apache" name=description><meta content="a small tutorial for how to setup Varnish cache for a flat site running on Apache" itemprop=description><meta content="a small tutorial for how to setup Varnish cache for a flat site running on Apache" property=og:description><meta content="a small tutorial for how to setup Varnish cache for a flat site running on Apache" name=twitter:description><link href=https://c.disquscdn.com rel=dns-prefetch><meta content=article property=og:type><meta content="Varnish For Static Sites | OhDoyleRules" property=og:title><meta content="james2doyle@gmail.com James Doyle" property=article:author><meta content="varnish, flat, file, site, apache, ubuntu, install, setup, config" itemprop=keywords><meta content="varnish, flat, file, site, apache, ubuntu, install, setup, config" property=article:tag><meta content="varnish, flat, file, site, apache, ubuntu, install, setup, config" property=og:keywords><link href=https://www.google-analytics.com rel=dns-prefetch><link rel="shortcut icon" href=/favicon.ico><link href=https://ohdoylerules.com/web/varnish-for-static-sites/ rel=canonical><link href=https://ohdoylerules.com/atom.xml rel=alternate title=atom type=application/atom+xml><style>:root{--b-font-main:system-ui,sans-serif;--b-font-mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;--b-txt:#dcd7ba;--b-bg-1:#18171f;--b-bg-2:#2d4f67;--b-line:#727169;--b-link:#7fb4ca;--b-btn-bg:#2d4f67;--b-btn-txt:#c8c093;--b-focus:#2d4f67;--b-accent-1:#e6c384;--b-accent-2:#c34043;--b-selection-color:#c8c093;--b-selection-bg:#2d4f67}*,:after,:before{box-sizing:border-box}:selection{color:var(--b-selection-color);background-color:var(--b-selection-bg)}html:focus-within{scroll-behavior:smooth}body{max-width:70ch;padding:0 1rem;margin:auto;background:var(--b-bg-1);font-family:var(--b-font-main);font-feature-settings:"lnum" 1;font-variant-numeric:slashed-zero;text-rendering:geometricPrecision;line-height:1.5;color:var(--b-txt);-moz-tab-size:4;tab-size:4;word-break:break-word;overflow-wrap:break-word;-webkit-tap-highlight-color:rgba(0,0,0,0);-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}address,audio,blockquote,dd,details,dl,fieldset,figure,h1,h2,h3,h4,h5,h6,hr,iframe,ol,p,pre,table,ul,video{margin:0 0 1.5rem}h1,h2,h3,h4,h5,h6{line-height:1.25;margin-top:2rem;text-wrap:balance}h1{font-size:2rem}h2{font-size:1.5rem}h3{font-size:1.25rem}h4{font-size:1rem}h5{font-size:.875rem}h6{font-size:.75rem}a{color:var(--b-link);text-decoration:none}a:hover{text-decoration:underline}img,svg,video{max-width:100%;height:auto}embed,iframe,object{max-width:100%}iframe{border-style:none;width:100%;height:100%}abbr[title]{text-decoration:underline dotted}b,strong{font-weight:700}blockquote{margin-left:0;margin-trim:block;padding:.5rem 0 .5rem 1.5rem;border-left:.25rem solid var(--b-accent-2)}blockquote p{margin-bottom:0}small{font-size:.875rem}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-0.25em}sup{top:-0.5em}hr{height:0;border:0;border-bottom:1px solid var(--b-line)}mark{background:var(--b-bg-2);border-radius:.25rem;padding:.125rem .25rem;color:var(--b-txt)}code,kbd,pre,samp,tt,var{background:var(--b-bg-2);border-radius:.25rem;padding:.125rem .25rem;font-family:var(--b-font-mono);font-size:.875em}pre{padding:1rem;overflow:auto;white-space:pre}pre code{padding:0;background-color:inherit}p code{background-color:var(--b-bg-2);color:var(--b-accent-1)}details{display:block;padding:.5rem 1rem;background:var(--b-bg-2);border:1px solid var(--b-line);border-radius:.25rem;margin-trim:block}details[open]>summary{margin-bottom:1.5rem}summary{display:list-item;cursor:pointer;font-weight:700}summary:focus{box-shadow:none}table{border-collapse:collapse;width:100%;text-indent:0}table caption{margin-bottom:.5rem}tr{border-bottom:1px solid var(--b-line)}td,th{padding:.5rem 0 .5rem 1rem;word-break:normal}td:first-child,th:first-child{padding-left:0}th{text-align:left}dd,ol,ul{padding-left:2rem}li>ol,li>ul{margin-bottom:0}fieldset{padding:.5rem .75rem;border:1px solid var(--b-line);border-radius:.25rem}legend{padding:0 .25rem}label{cursor:pointer;display:block;margin-bottom:.25rem}button,input,select,textarea{margin:0;padding:.5rem .75rem;max-width:100%;background:var(--b-bg-2);border:0;border-radius:.25rem;font:inherit;line-height:1.125;color:var(--b-txt)}button,select{text-transform:none}[type=date],[type=datetime-local],[type=datetime],[type=email],[type=month],[type=number],[type=password],[type=search],[type=tel],[type=text],[type=time],[type=url],[type=week],select{width:100%}[type=checkbox],[type=image],[type=radio]{cursor:pointer}[type=color]{min-height:2.125rem}select:not([multiple]):not([size]){padding-right:1.5rem;background-repeat:no-repeat;background-position:right .5rem center;-moz-appearance:none;-webkit-appearance:none;appearance:none}textarea{width:100%;resize:vertical}textarea:not([rows]){height:8rem}button{touch-action:manipulation}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button;display:inline-block;text-align:center;white-space:nowrap;background:var(--b-btn-bg);color:var(--b-btn-txt);border:0;cursor:pointer;transition:opacity .25s}[type=button]:hover,[type=reset]:hover,[type=submit]:hover,button:hover{opacity:.75}[type=button][disabled],[type=reset][disabled],[type=submit][disabled],button[disabled]{opacity:.5}progress{vertical-align:baseline}[type=search]{-webkit-appearance:none;outline-offset:-2px}:-webkit-inner-spin-button,:-webkit-outer-spin-button{height:auto}:-webkit-input-placeholder{color:inherit;opacity:.5}:-webkit-search-decoration{-webkit-appearance:none}:-webkit-file-upload-button{-webkit-appearance:button;font:inherit}:-moz-focus-inner{border-style:none;padding:0}:-moz-focusring{outline:1px dotted ButtonText}:-moz-ui-invalid{box-shadow:none}[aria-busy=true]{cursor:progress}[aria-disabled=true],[disabled]{cursor:not-allowed}:focus,details:focus-within{outline:none;box-shadow:0 0 0 2px var(--b-focus)}@media (prefers-reduced-motion: reduce){html:focus-within{scroll-behavior:auto}*,:after,:before{animation-delay:-1ms!important;animation-duration:1ms!important;animation-iteration-count:1!important;background-attachment:initial!important;scroll-behavior:auto!important;transition-delay:0!important;transition-duration:0!important}}select:not([multiple]):not([size]){background-image:url("data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg' fill='%23eceff4'%3E%3Cpath d='M5 6l5 5 5-5 2 1-7 7-7-7 2-1z'/%3E%3C/svg%3E")}a.none{color:inherit;border:none;opacity:1}a.none:hover {background:none;opacity:.6}.center{text-align:center}html.is-changing .transition-fade{view-transition-name:main}:view-transition-old(main){animation:fade .25s ease-in-out both}:view-transition-new(main){animation:fade .25s ease-in-out both reverse}@keyframes fade{from{opacity:1}to{opacity:0}}html.is-changing:not(.swup-native) .transition-fade {will-change:opacity;transition:.25s opacity;opacity:1}html.is-animating:not(.swup-native) .transition-fade {opacity:0}</style><style>.post-info{margin-bottom:1rem}.center img{max-width:100%;height:auto}pre code.language-diff span:nth-child(1n + 7){color:#50fa7b}iframe{border:0;margin:0;min-height:300px}.gist-iframe{background-color:white;filter:invert(1) hue-rotate(180deg) brightness(1)}body table.highlight tr:nth-child(even){background-color:#f6f8fa}body table.highlight td,body table.highlight th{border-color:rgba(27,31,35,.3)}</style><body><main class=transition-fade id=swup><header class=center><h1 itemprop="name headline">Varnish For Static Sites</h1></header><hr><div itemscope itemtype=http://schema.org/BlogPosting><div><p><a title="Go Back Home" href=https://ohdoylerules.com>Go home</a><article><section class=post-info><span itemprop=datePublished> ðŸ•’Â Â  <time datetime=2015-09-20T00:00:00>September 20, 2015</time> </span></section><div itemprop="ArticleBody text" class=main-content><p>Recently, <a rel="noopener nofollow noreferrer" href=http://warpaintmedia.ca target=_blank>my company</a> had a request to build a series of sites that could handle huge bursts of traffic. I asked some friends of mine, what a good solution for this would be. All of them said <a rel="noopener nofollow noreferrer" href=https://www.varnish-cache.org/ target=_blank>Varnish</a>.<p>If you don't know what Varnish is, check out this definition from their documentation:<blockquote><p>Varnish Cache is a web application accelerator also known as a caching HTTP reverse proxy. You install it in front of any server that speaks HTTP and configure it to cache the contents. Varnish Cache is really, really fast. It typically speeds up delivery with a factor of 300 - 1000x, depending on your architecture.</blockquote><p>So you can see that having this tool would be really nice. A simple way to get started with Varnish is to set it up on a flat-file site. Maybe something like <a rel="noopener nofollow noreferrer" href=http://philecms.com/ target=_blank>PhileCMS</a> perhaps? Here is <a rel="noopener nofollow noreferrer" href=https://www.staticgen.com/ target=_blank>a nice curated list</a> of flat-file site generators.<h3 id=setting-up>Setting Up</h3><p>This tutorial assumes the following:<ul><li>You are using Ubuntu 14.04<li>You have <a rel="noopener nofollow noreferrer" href=https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-varnish-with-apache-on-ubuntu-12-04--3 target=_blank>Varnish and Apache installed</a> *</ul><p>* This tutorial is for Ubuntu 12.04. Replace this command: <code>deb http://repo.varnish-cache.org/ubuntu/ lucid varnish-3.0</code> with this one <code>deb http://repo.varnish-cache.org/ubuntu/ trusty varnish-4.0</code><h3 id=apache-setup>Apache Setup</h3><p>First, you will want to serve Apache on a different port, because Varnish is going to act as our "web server" and Apache will only be used if the cache is stale or there is no item in the Varnish cache.<p>We can open <code>/etc/apache2/ports.conf</code> and make the following change:<pre style=background:#2b303b;color:#c0c5ce><code><span># Listen 80
</span><span>Listen 127.0.0.1:8080
</span></code></pre><p>We commented out the original listening port, and added our own.<p>If we have any sites setup, we should change their virtual host files as well. These files live in <code>/etc/apache2/sites-available</code> and end in <code>.conf</code>, so this demo file might be called <code>example.com.conf</code><pre style=background:#2b303b;color:#c0c5ce><code><span>&LTVirtualHost *:8080>
</span><span>  ServerAdmin hello@example.com
</span><span>  ServerName  www.example.com
</span><span>  ServerAlias example.com
</span><span>  DocumentRoot /var/www/html/example.com
</span><span>&LT/VirtualHost>
</span></code></pre><p>If this site is not enabled, it would be done with the command <code>a2ensite example.com</code>.<h4 id=remove-caching-and-header-changes>Remove Caching And Header Changes</h4><p>You need to <strong>disable all caching in Apache</strong>!<p>Varnish works by reading headers from any files served from our normal web server. Having caching in Apache might seem like killing 2 birds with 1 stone, but it doesn't work that way.<p>Rules you might want to check for in your <code>apache.conf</code> files:<ul><li>mod_headers - used for modifying headers, use with caution<li>mod_deflate - for setting compression details<li>mod_filter - used with mod_deflate for setting compression<li>mod_expires - used for setting how long to cache files, use with caution</ul><p>These different rule sets usually contain settings that would be great if we were <em>not</em> using Varnish. In this case, we are going to trust Varnish to manage all the headers for us.<p>When everything is good to go, restart Apache with <code>service apache2 restart</code>.<h3 id=varnish-setup>Varnish Setup</h3><p>First, we need to tell Varnish to live on port 80. We do that by editing the settings for the Varnish daemon.<p>The file we need to edit is <code>/etc/default/varnish</code>. Scroll down until you see the uncommented lines with code that looks like it does below. We need to it like this:<pre style=background:#2b303b;color:#c0c5ce><code><span>DAEMON_OPTS="-a :80 \
</span><span>             -T localhost:6082 \
</span><span>             -f /etc/varnish/default.vcl \
</span><span>             -S /etc/varnish/secret \
</span><span>             -s malloc,256m"
</span></code></pre><p>Most likely, you will only change the <code>-a</code> part to <code>80</code>.<p>Our Varnish configuration for our site lives at <code>/etc/varnish/default.vcl</code>, here is the one I am using:</p><iframe class="gist-iframe iframes" srcdoc="<script src='https://gist.github.com/james2doyle/0feec6ab77078ad3fdce.js'></script>" id=https://gist.github.com/james2doyle/0feec6ab77078ad3fdce.js src=about:blank></iframe><p>It is very basic. I really only want to cache text files (HTML, CSS, Javascript/JSON) and images.<p>To restart Varnish, use <code>service varnish restart</code>.<h4 id=restarting-varnish>Restarting Varnish</h4><p>If you restart or run out of memory, Varnish will rebuild the cache. This isn't great because you are trying to keep Varnish alive and the cache enabled.<h3 id=testing>Testing</h3><p>At this point we are ready to test.<p>I would suggest running the command <code>vanrnishstat</code> on your remote server so you can see things happening in the Varnish cache. Pressing the arrow keys up and down will give you a description of the item.<p>Then you can go to you site and click around. You should see the Varnish Stat table getting updated. You will want to watch the <em>MAIN.cache_hit</em> and <em>MAIN.cache_miss</em> numbers.<p>You want the <em>MAIN.cache_hit</em> to be as high as possible. This means that your Apache is not getting tapped for information, but Varnish is serving it straight to the client.<p>For the <em>MAIN.cache_miss</em>, you want that to be as low as possible. This number represents the number of times that Varnish had to hit Apache. Having a low <em>MAIN.cache_miss</em> means that we are only tapping Apache when we must.<h4 id=troubleshooting>Troubleshooting</h4><p>Since we added that line in our <code>default.vcl</code> file for <code>X-Cache</code>, we can see which files are being served by Varnish. Using dev tools in Chrome/Safari or Firefox, we can look for a header in our request called <code>X-Cache</code>.<div class=center><a title="Varnish x-cache header example" href=/images/varnish-x-cache.png target=_blank><img alt="Varnish x-cache header example" src=/images/varnish-x-cache.png></a></div><p>You can see that this item was <em>HIT</em>. This means that it will be counted in the <em>MAIN.cache_hit</em> column and not <em>MAIN.cache_miss</em> column. Good!<p>Things that mess up Varnish are headers and cookie headers especially. Sometimes you want or need some headers though. This setup does not allow any cookies to get through. If you had a normal CMS with this setup, you would find you wouldn't be able to log in, or there might be some CSRF Token (Cross Site Request Forgery) issues with form submissions if you use CSRF.<p>Varnish will let you control different areas where cookies or other things can change. You will want to refer to the <a rel="noopener nofollow noreferrer" href=https://www.varnish-cache.org/trac/wiki/VCLExampleRemovingSomeCookies target=_blank>Varnish Documentation</a> for these advanced features.</div><p><a title="Go Back Home" href=https://ohdoylerules.com>Go home</a><hr><div class="media grid"><div class=media-left><a class=post-author-link href=https://twitter.com/james2doyle target=_blank> <img alt="James Doyle Profile Picture" src="https://www.gravatar.com/avatar/b7375c88e1864c4ddf0d7bdab58e4cca?s=120&d=mm&r=g" height=120 width=120> </a></div><div class="media-body cell -9of12"><div class=media-heading><h3 itemprop="author publisher creator provider">James Doyle</h3></div><div class=media-content><p>I'm a full-stack developer, co-organizer of <a title="PHP Vancouver" href=https://www.meetup.com/vancouver-php target=_blank>PHP Vancouver</a> meetup, and winner of a <a title="Canadian Developer 30 under 30 award" href=http://www.canadianbusiness.com/innovation/developer-30-under-30-gallery/image/20/ target=_blank>Canadian Developer 30 under 30 award</a>. I'm a huge Open Source advocate and contributor to a lot of projects in my community. When I am not sitting at a computer, I'm trying to perfect some other skill.</div></div></div></article></div></div></main><script defer src=https://unpkg.com/swup@4.8.1/dist/Swup.umd.js></script><script>function handleGists(){const a=document.querySelectorAll('.iframes');[...a].forEach(function(b){b.onload=function(){b.style.height=b.contentWindow.document.body.scrollHeight+ 16+ 'px'};b.style.height=b.contentWindow.document.body.scrollHeight+ 16+ 'px'})}document.addEventListener('DOMContentLoaded',function(){handleGists();const a=new Swup({native:true});a.hooks.on('visit:end',handleGists,{priority:100})})</script>