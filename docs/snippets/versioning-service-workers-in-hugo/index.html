<!doctype html><html lang=en><head><meta charset=utf-8><meta content=public http-equiv=Cache-control><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1,maximum-scale=5" name=viewport><title>Versioning Service Workers In Hugo | OhDoyleRules</title><meta content="Versioning Service Workers In Hugo | OhDoyleRules" name=twitter:title><meta content=KM-5h_iJ7JJsGeUp4ncEoYCBKft1ko1A4gBpjIzT0p4 name=google-site-verification><meta content="Versioning Service Workers In Hugo" itemprop=name><meta content=OhDoyleRules property=og:site_name><meta content=https://ohdoylerules.com/snippets/versioning-service-workers-in-hugo/ itemprop=url><meta content=james2doyle@gmail.com itemprop=email><meta content=https://ohdoylerules.com/snippets/versioning-service-workers-in-hugo/ property=og:url><meta itemprop="image logo" content=/icons/logo.png><meta content=/icons/logo.png property=og:image><link href=/icons/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><link href=/icons/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/icons/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/site.webmanifest rel=manifest><link color=#333333 href=/icons/safari-pinned-tab.svg rel=mask-icon><link href=/icons/favicon.ico rel=icon sizes=any><link href=/icons/favicon.svg rel=icon type=image/svg+xml><meta content=/browserconfig.xml name=msapplication-config><meta content=#ffffff name=msapplication-TileColor><meta content=#ffffff name=theme-color><meta content=summary name=twitter:card><meta content=@james2doyle name=twitter:site><meta content="Versioning Service Workers In Hugo" name=twitter:title><meta content=@james2doyle name=twitter:creator><meta content=/icons/logo.png name=twitter:image><meta content=/ name=twitter:domain><link href=/icons/logo.svg rel=icon><meta content="How to use Hugo pipes and resources to version your service worker scripts" name=description><meta content="How to use Hugo pipes and resources to version your service worker scripts" itemprop=description><meta content="How to use Hugo pipes and resources to version your service worker scripts" property=og:description><meta content="How to use Hugo pipes and resources to version your service worker scripts" name=twitter:description><meta content=article property=og:type><meta content="Versioning Service Workers In Hugo | OhDoyleRules" property=og:title><meta content="james2doyle@gmail.com James Doyle" property=article:author><meta content="hugo, sw, service worker, version, bust, clear, script, resources, pipes" itemprop=keywords><meta content="hugo, sw, service worker, version, bust, clear, script, resources, pipes" property=article:tag><meta content="hugo, sw, service worker, version, bust, clear, script, resources, pipes" property=og:keywords><link href=https://www.google-analytics.com rel=dns-prefetch><link rel="shortcut icon" href=/favicon.ico><link href=https://ohdoylerules.com/snippets/versioning-service-workers-in-hugo/ rel=canonical><link href=https://ohdoylerules.com/atom.xml rel=alternate title=atom type=application/atom+xml><style>:root{--b-font-main:system-ui,sans-serif;--b-font-mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;--b-txt:#dcd7ba;--b-bg-1:#18171f;--b-bg-2:#2d4f67;--b-line:#727169;--b-link:#ffa066;--b-heading:#fff;--b-btn-bg:#2d4f67;--b-btn-txt:#c8c093;--b-focus:#2d4f67;--b-accent-1:#e6c384;--b-accent-2:#c34043;--b-selection-color:#c8c093;--b-selection-bg:#2d4f67}*,:before,:after{box-sizing:border-box}::selection{color:var(--b-selection-color);background-color:var(--b-selection-bg)}html:focus-within{scroll-behavior:smooth}body{background:var(--b-bg-1);font-family:var(--b-font-main);font-feature-settings:"lnum" 1;font-variant-numeric:slashed-zero;text-rendering:geometricprecision;color:var(--b-txt);-moz-tab-size:4;tab-size:4;word-break:break-word;overflow-wrap:break-word;-webkit-tap-highlight-color:#0000;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;max-width:70ch;margin:auto;padding:0 1rem;line-height:1.5}h1,h2,h3,h4,h5,h6,p,ul,ol,dl,dd,details,blockquote,pre,figure,table,address,hr,fieldset,iframe,audio,video{margin:0 0 1.5rem}h1,h2,h3,h4,h5,h6{text-wrap:balance;color:var(--b-heading);margin-top:2rem;line-height:1.25}h1{font-size:2rem}h2{font-size:1.5rem}h3{font-size:1.25rem}h4{font-size:1rem}h5{font-size:.875rem}h6{font-size:.75rem}a{color:var(--b-link);text-decoration:underline}a:hover{text-decoration:underline}img,video,svg{max-width:100%;height:auto}embed,iframe,object{max-width:100%}iframe{border-style:none;width:100%;height:100%}abbr[title]{text-decoration:underline dotted}b,strong{font-weight:700}blockquote{border-left:.25rem solid var(--b-accent-2);margin-left:0;padding:.5rem 0 .5rem 1.5rem}blockquote p{margin-bottom:0}small{font-size:.875rem}sub,sup{vertical-align:baseline;font-size:75%;line-height:0;position:relative}sub{bottom:-.25em}sup{top:-.5em}hr{border:0;border-bottom:1px solid var(--b-line);height:0}mark{background:var(--b-bg-2);color:var(--b-txt);border-radius:.25rem;padding:.125rem .25rem}pre,code,kbd,samp,tt,var{background:var(--b-bg-2);font-family:var(--b-font-mono);border-radius:.25rem;padding:.125rem .25rem;font-size:.875em}pre{white-space:pre;padding:1rem;overflow:auto}pre code{background-color:inherit;padding:0}p code{background-color:var(--b-bg-2);color:var(--b-accent-1)}details{background:var(--b-bg-2);border:1px solid var(--b-line);border-radius:.25rem;padding:.5rem 1rem;display:block}details[open]>summary{margin-bottom:1.5rem}summary{cursor:pointer;font-weight:700;display:list-item}summary:focus{box-shadow:none}table{border-collapse:collapse;text-indent:0;width:100%}table caption{margin-bottom:.5rem}tr{border-bottom:1px solid var(--b-line)}td,th{word-break:normal;padding:.5rem 0 .5rem 1rem}td:first-child,th:first-child{padding-left:0}th{text-align:left}ul,ol,dd{padding-left:2rem}li>ul,li>ol{margin-bottom:0}fieldset{border:1px solid var(--b-line);border-radius:.25rem;padding:.5rem .75rem}legend{padding:0 .25rem}label{cursor:pointer;margin-bottom:.25rem;display:block}button,input,select,textarea{background:var(--b-bg-2);font:inherit;color:var(--b-txt);border:0;border-radius:.25rem;max-width:100%;margin:0;padding:.5rem .75rem;line-height:1.125}button,select{text-transform:none}select,[type=date],[type=datetime-local],[type=datetime],[type=email],[type=month],[type=number],[type=password],[type=search],[type=tel],[type=text],[type=time],[type=url],[type=week]{width:100%}[type=image],[type=checkbox],[type=radio]{cursor:pointer}[type=color]{min-height:2.125rem}select:not([multiple]):not([size]){-webkit-appearance:none;-moz-appearance:none;appearance:none;background-position:right .5rem center;background-repeat:no-repeat;padding-right:1.5rem}textarea{resize:vertical;width:100%}textarea:not([rows]){height:8rem}button{touch-action:manipulation}button,[type=button],[type=submit],[type=reset]{-webkit-appearance:button;text-align:center;white-space:nowrap;background:var(--b-btn-bg);color:var(--b-btn-txt);cursor:pointer;border:0;transition:opacity .25s;display:inline-block}button:hover,[type=button]:hover,[type=submit]:hover,[type=reset]:hover{opacity:.75}button[disabled],[type=button][disabled],[type=submit][disabled],[type=reset][disabled]{opacity:.5}progress{vertical-align:baseline}[type=search]{-webkit-appearance:none;outline-offset:-2px}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}::-webkit-input-placeholder{color:inherit;opacity:.5}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}::-moz-focus-inner{border-style:none;padding:0}:-moz-focusring{outline:1px dotted buttontext}:-moz-ui-invalid{box-shadow:none}[aria-busy=true]{cursor:progress}[aria-disabled=true],[disabled]{cursor:not-allowed}:focus,details:focus-within{box-shadow:0 0 0 2px var(--b-focus);outline:none}@media (prefers-reduced-motion:reduce){html:focus-within{scroll-behavior:auto}*,:before,:after{background-attachment:initial!important;scroll-behavior:auto!important;transition-delay:0!important;transition-duration:0!important;animation-duration:1ms!important;animation-iteration-count:1!important;animation-delay:-1ms!important}}select:not([multiple]):not([size]){background-image:url("data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg' fill='%23eceff4'%3E%3Cpath d='M5 6l5 5 5-5 2 1-7 7-7-7 2-1z'/%3E%3C/svg%3E")}.post-info,.center img{margin-bottom:1rem}a.none{color:inherit;opacity:1;border:none}a.none:hover{opacity:.6;background:0 0}.center{text-align:center}html.is-changing .transition-fade{view-transition-name:main}::view-transition-old(main){animation:.25s ease-in-out both fade}::view-transition-new(main){animation:.25s ease-in-out reverse both fade}@keyframes fade{0%{opacity:1}to{opacity:0}}html.is-changing:not(.swup-native) .transition-fade{will-change:opacity;opacity:1;transition:opacity .25s}html.is-animating:not(.swup-native) .transition-fade{opacity:0}.render-later{content-visibility:auto;contain-intrinsic-size:auto 166px}</style><style>.center img{max-width:100%;height:auto}pre code.language-diff span:nth-child(n+7){color:#50fa7b}iframe{border:0;min-height:300px;margin:0}.gist-iframe{filter:invert()hue-rotate(180deg)brightness();background-color:#fff}body table.highlight tr:nth-child(2n){background-color:#f6f8fa}body table.highlight td,body table.highlight th{border-color:#1b1f234d}</style><body><main class=transition-fade id=swup><header class=center><h1 itemprop="name headline">Versioning Service Workers In Hugo</h1></header><hr><div itemscope itemtype=http://schema.org/BlogPosting><div><p><a title="Go Back Home" href=https://ohdoylerules.com>Go home</a><article><section class=post-info><span itemprop=datePublished> ðŸ•’Â Â  <time datetime=2022-08-21T00:00:00>August 21, 2022</time> </span></section><div itemprop="ArticleBody text" class=main-content><p>I have been running this blog on <a rel="noopener nofollow noreferrer" href=https://gohugo.io/ target=_blank>Hugo</a> for quite some time. It is fast, well supported, and full of features. Until recently, one of the features I was not taking advantage of was the <a rel="noopener nofollow noreferrer" href=https://gohugo.io/hugo-pipes/introduction/ target=_blank>pipes feature</a>.<p>For all intents and purposes, pipes are used for processing strings and templates. They are "assets" that are used on your site. They live outside your theme at the top level <code>/assets</code> folder in your Hugo project. But you can also pull in remote assets via a URL and Hugo will pull that in when you build your site.<p>From the day I switched to Hugo, I was always <a rel="noopener nofollow noreferrer" href=https://developer.chrome.com/docs/workbox/caching-strategies-overview/#cache-only target=_blank>using a service worker to cache my sites static assets</a>. The challenge I had was how to bust the cache. The old way I was doing this was to add a query string on the end of my <code>sw.js</code> URL. Something like this:<pre class=language-js data-lang=js style=color:#c0c5ce;background-color:#2b303b><code class=language-js data-lang=js><span>navigator.</span><span style=color:#bf616a>serviceWorker</span><span>.</span><span style=color:#8fa1b3>register</span><span>('</span><span style=color:#a3be8c>sw.js?{{ now.Format "2006-01-02" }}</span><span>');
</span></code></pre><p>This seemed to work <em>just OK</em>. I think maybe in the last couple years the browser's changed and they would still cache this file even when the URL was different. It would not reload the service worker and therefore update the cache with new articles making my site seem stale even though there was new content.<p>I can't say for sure but it used to work in the past and then one day it did not...<p>Now that this is a known issue in my site, I need a way to bust the cache in the service worker file itself instead of relying on the file's URL.<p>What I need to do is treat the <code>sw.js</code> file as a template so I can pass in a variable and tell the file it is new each time I deploy.<p>In this case, it is pipes to the rescue! Here is the code that runs in my <code>footer.html</code> file:<pre class=language-handlebars data-lang=handlebars style=color:#c0c5ce;background-color:#2b303b><code class=language-handlebars data-lang=handlebars><span style=color:#65737e>&LT!-- Get the file in "assets/service-worker.js" -->
</span><span>{{ </span><span style=color:#bf616a>$jsTemplate</span><span> := </span><span style=color:#bf616a>resources.Get </span><span>"</span><span style=color:#a3be8c>service-worker.js</span><span>" }}
</span><span style=color:#65737e>&LT!-- We are making a new file called "sw.js" -->
</span><span>{{ </span><span style=color:#bf616a>$js</span><span> := $</span><span style=color:#bf616a>jsTemplate</span><span> | </span><span style=color:#bf616a>resources.ExecuteAsTemplate </span><span>"</span><span style=color:#a3be8c>sw.js</span><span>" . }}
</span><span><</span><span style=color:#bf616a>script</span><span> defer>
</span><span>  </span><span style=color:#65737e>// register the service worker only when not in development
</span><span>{{ </span><span style=color:#b48ead>if </span><span style=color:#bf616a>eq </span><span>(</span><span style=color:#bf616a>printf </span><span>"</span><span style=color:#a3be8c>%v</span><span>" </span><span style=color:#bf616a>$</span><span>.Site.BaseURL) "</span><span style=color:#a3be8c>http://localhost:1313/</span><span>" }}
</span><span>  console.</span><span style=color:#96b5b4>info</span><span>('</span><span style=color:#a3be8c>on localhost - not loading service worker. Query: {{ $js.Permalink }} {{ now.Format "2006-01-02" }}</span><span>');
</span><span>{{ </span><span style=color:#b48ead>else </span><span>}}
</span><span>  </span><span style=color:#b48ead>if </span><span>('</span><span style=color:#a3be8c>serviceWorker</span><span>' in navigator) {
</span><span>    navigator.serviceWorker.</span><span style=color:#bf616a>register</span><span>('</span><span style=color:#a3be8c>{{ $js.Permalink }}</span><span>');
</span><span>  }
</span><span>{{ </span><span style=color:#bf616a>end </span><span>}}
</span><span>&LT/</span><span style=color:#bf616a>script</span><span>>
</span></code></pre><p>That is all you need to read that asset file and create a URL so a "compiled" version. If you want to see this file, you can just visit the URL it creates: <code>http://localhost:1313/sw.js</code><p>And here is the code in <code>assets/service-worker.js</code> that gets parsed as a go html template:<pre class=language-handlebars data-lang=handlebars style=color:#c0c5ce;background-color:#2b303b><code class=language-handlebars data-lang=handlebars><span>// cache name will change to the date of my last deploy
</span><span>const CACHE_NAME = 'ODR-{{ </span><span style=color:#bf616a>now.Format </span><span>"</span><span style=color:#a3be8c>2006-01-02</span><span>" }}';
</span><span>const expectedCaches = [CACHE_NAME];
</span><span>
</span><span>// the list of files that need to be cached
</span><span>const staticFiles = [
</span><span>  './',
</span><span>  './css/site.css',
</span><span>  './icons/logo.svg',
</span><span>  './manifest.json',
</span><span>  './favicon.ico',
</span><span>];
</span><span>
</span><span>/**
</span><span> * Performs install steps.
</span><span> */
</span><span>addEventListener('install', (event) => {
</span><span>  // install this service worker as soon as a new one is available
</span><span>  skipWaiting();
</span><span>  event.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(staticFiles)));
</span><span>});
</span><span>
</span><span>/**
</span><span> * Handles requests: responds with cache or else network.
</span><span> */
</span><span>addEventListener('fetch', (event) => {
</span><span>  event.respondWith(caches.match(event.request).then(response => response || fetch(event.request)));
</span><span>});
</span><span>
</span><span>/**
</span><span> * Cleans up static cache and activates the Service Worker.
</span><span> */
</span><span>addEventListener('activate', (event) => {
</span><span>  event.waitUntil(caches.keys().then(keys => Promise.all(keys.map((key) => {
</span><span>    if (!expectedCaches.includes(key)) {
</span><span>      return caches.delete(key);
</span><span>    }
</span><span>  }))).then(() => {
</span><span>    console.log(`${CACHE_NAME} now ready to handle fetches!`);
</span><span>    return clients.claim();
</span><span>  }));
</span><span>});
</span></code></pre><p>As you will be able to see if you visited the file that gets generated at <code>http://localhost:1313/sw.js</code>, the <code>CACHE_NAME</code> is now being defined with a value that includes todays date!<p>Something like this:<pre class=language-js data-lang=js style=color:#c0c5ce;background-color:#2b303b><code class=language-js data-lang=js><span style=color:#65737e>// you should see a real string being assigned now and not a go template interpolation
</span><span style=color:#b48ead>const </span><span style=color:#bf616a>CACHE_NAME </span><span>= '</span><span style=color:#a3be8c>ODR-2022-08-21</span><span>';
</span><span style=color:#b48ead>const </span><span style=color:#bf616a>expectedCaches </span><span>= [</span><span style=color:#bf616a>CACHE_NAME</span><span>];
</span><span>
</span><span style=color:#65737e>//... the rest of the file...
</span></code></pre><p>Now when you build the site, this new piped/resource file will generated too and properly linked in your templates.<p>Once I got this all setup, I can now deploy my site and know for sure that my service worker cache will be busted since it will be created with a key that includes the date of my deploy.</div><p><a title="Go Back Home" href=https://ohdoylerules.com>Go home</a><hr><div class="media grid"><div class=media-left><a class=post-author-link href=https://twitter.com/james2doyle target=_blank> <img alt="James Doyle Profile Picture" src="https://www.gravatar.com/avatar/b7375c88e1864c4ddf0d7bdab58e4cca?s=120&d=mm&r=g" height=120 width=120> </a></div><div class="media-body cell -9of12"><div class=media-heading><h3 itemprop="author publisher creator provider">James Doyle</h3></div><div class=media-content><p>I'm a full-stack developer, co-organizer of <a title="PHP Vancouver" href=https://www.meetup.com/vancouver-php target=_blank>PHP Vancouver</a> meetup, and winner of a <a title="Canadian Developer 30 under 30 award" href=http://www.canadianbusiness.com/innovation/developer-30-under-30-gallery/image/20/ target=_blank>Canadian Developer 30 under 30 award</a>. I'm a huge Open Source advocate and contributor to a lot of projects in my community. When I am not sitting at a computer, I'm trying to perfect some other skill.</div></div></div></article></div></div></main><script defer src=https://unpkg.com/swup@4.8.1/dist/Swup.umd.js></script><script>var handleGists=(()=>{let b=16,c=`px`;const a=document.querySelectorAll(`.iframes`);[...a].forEach((a=>{a.onload=(()=>{a.style.height=a.contentWindow.document.body.scrollHeight+ b+ c});a.style.height=a.contentWindow.document.body.scrollHeight+ b+ c}))});document.addEventListener(`DOMContentLoaded`,(()=>{handleGists();const a=new Swup({native:!0});a.hooks.on(`visit:end`,handleGists,{priority:100})}))</script>