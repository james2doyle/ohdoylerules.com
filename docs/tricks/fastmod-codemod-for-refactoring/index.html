<!doctype html><html lang=en><head><meta charset=utf-8><meta content=public http-equiv=Cache-control><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1,maximum-scale=5" name=viewport><title>Fastmod Codemod For Refactoring | OhDoyleRules</title><meta content="Fastmod Codemod For Refactoring | OhDoyleRules" name=twitter:title><meta content=KM-5h_iJ7JJsGeUp4ncEoYCBKft1ko1A4gBpjIzT0p4 name=google-site-verification><meta content="Fastmod Codemod For Refactoring" itemprop=name><meta content=OhDoyleRules property=og:site_name><meta content=https://ohdoylerules.com/tricks/fastmod-codemod-for-refactoring/ itemprop=url><meta content=james2doyle@gmail.com itemprop=email><meta content=https://ohdoylerules.com/tricks/fastmod-codemod-for-refactoring/ property=og:url><meta itemprop="image logo" content=/icons/logo.png><meta content=/icons/logo.png property=og:image><link href=/icons/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><link href=/icons/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/icons/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/site.webmanifest rel=manifest><link color=#333333 href=/icons/safari-pinned-tab.svg rel=mask-icon><link href=/icons/favicon.ico rel=icon sizes=any><link href=/icons/favicon.svg rel=icon type=image/svg+xml><meta content=/browserconfig.xml name=msapplication-config><meta content=#ffffff name=msapplication-TileColor><meta content=#ffffff name=theme-color><meta content=summary name=twitter:card><meta content=@james2doyle name=twitter:site><meta content="Fastmod Codemod For Refactoring" name=twitter:title><meta content=@james2doyle name=twitter:creator><meta content=/icons/logo.png name=twitter:image><meta content=/ name=twitter:domain><link href=/icons/logo.svg rel=icon><meta content="Fastmod is a command line tool that can help you with large-scale codebase refactors" name=description><meta content="Fastmod is a command line tool that can help you with large-scale codebase refactors" itemprop=description><meta content="Fastmod is a command line tool that can help you with large-scale codebase refactors" property=og:description><meta content="Fastmod is a command line tool that can help you with large-scale codebase refactors" name=twitter:description><link href=https://c.disquscdn.com rel=dns-prefetch><meta content=article property=og:type><meta content="Fastmod Codemod For Refactoring | OhDoyleRules" property=og:title><meta content="james2doyle@gmail.com James Doyle" property=article:author><meta content="refactor, code, delete, remove, replace, find, webpack, rewrite, fix, fastmod, codemod" itemprop=keywords><meta content="refactor, code, delete, remove, replace, find, webpack, rewrite, fix, fastmod, codemod" property=article:tag><meta content="refactor, code, delete, remove, replace, find, webpack, rewrite, fix, fastmod, codemod" property=og:keywords><link href=https://www.google-analytics.com rel=dns-prefetch><link rel="shortcut icon" href=/favicon.ico><link href=https://ohdoylerules.com/tricks/fastmod-codemod-for-refactoring/ rel=canonical><link href=https://ohdoylerules.com/atom.xml rel=alternate title=atom type=application/atom+xml><style>body{font-feature-settings:'lnum' 1;font-variant-numeric:slashed-zero;text-rendering:geometricPrecision;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;-webkit-tap-highlight-color:rgba(0,0,0,0);-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%}.post-info{margin-bottom:1rem}a.none{color:inherit;border:none;opacity:1}a.none:hover {background:none;opacity:.6}.center{text-align:center}html.is-changing .transition-fade{view-transition-name:main}:view-transition-old(main){animation:fade .25s ease-in-out both}:view-transition-new(main){animation:fade .25s ease-in-out both reverse}@keyframes fade{from{opacity:1}to{opacity:0}}html.is-changing:not(.swup-native) .transition-fade {will-change:opacity;transition:.25s opacity;opacity:1}html.is-animating:not(.swup-native) .transition-fade {opacity:0}:root{--nc-font-sans:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Open Sans','Helvetica Neue',sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";--nc-font-mono:Consolas,monaco,'Ubuntu Mono','Liberation Mono','Courier New',Courier,monospace;--nc-tx-1:#fff;--nc-tx-2:#eee;--nc-bg-1:#000;--nc-bg-2:#111;--nc-bg-3:#222;--nc-lk-1:#3291ff;--nc-lk-2:#0070f3;--nc-lk-tx:#fff;--nc-ac-1:#7928ca;--nc-ac-tx:#fff}@media (prefers-color-scheme:dark){:root{--nc-tx-1:#fff;--nc-tx-2:#eee;--nc-bg-1:#000;--nc-bg-2:#111;--nc-bg-3:#222;--nc-lk-1:#3291ff;--nc-lk-2:#0070f3;--nc-lk-tx:#fff;--nc-ac-1:#7928ca;--nc-ac-tx:#fff}}*{margin:0;padding:0}address,area,article,aside,audio,blockquote,datalist,details,dl,fieldset,figure,form,iframe,img,input,meter,nav,ol,optgroup,option,output,p,pre,progress,ruby,section,table,textarea,ul,video{margin-bottom:1rem}button,html,input,select{font-family:var(--nc-font-sans)}body{margin:0 auto;max-width:750px;padding:2rem;border-radius:6px;overflow-x:hidden;word-break:break-word;overflow-wrap:break-word;background:var(--nc-bg-1);color:var(--nc-tx-2);font-size:1.03rem;line-height:1.5}:selection{background:var(--nc-ac-1);color:var(--nc-ac-tx)}h1,h2,h3,h4,h5,h6{line-height:1;color:var(--nc-tx-1);padding-top:.875rem}h1,h2,h3{color:var(--nc-tx-1);padding-bottom:2px;margin-bottom:8px;border-bottom:1px solid var(--nc-bg-2)}h4,h5,h6{margin-bottom:.3rem}h1{font-size:2.25rem}h2{font-size:1.85rem}h3{font-size:1.55rem}h4{font-size:1.25rem}h5{font-size:1rem}h6{font-size:.875rem}a{color:var(--nc-lk-1)}a:hover{color:var(--nc-lk-2)}abbr:hover{cursor:help}blockquote{padding:1.5rem;background:var(--nc-bg-2);border-left:5px solid var(--nc-bg-3)}abbr{cursor:help}blockquote:last-child{padding-bottom:0;margin-bottom:0}header{background:var(--nc-bg-2);border-bottom:1px solid var(--nc-bg-3);padding:2rem 1.5rem;margin:-2rem calc(0px - (50vw - 50%)) 2rem;padding-left:calc(50vw - 50%);padding-right:calc(50vw - 50%)}header h1,header h2,header h3{padding-bottom:0;border-bottom:0}header>:first-child{margin-top:0;padding-top:0}header>:last-child{margin-bottom:0}a button,button,input[type=button],input[type=reset],input[type=submit]{font-size:1rem;display:inline-block;padding:6px 12px;text-align:center;text-decoration:none;white-space:nowrap;background:var(--nc-lk-1);color:var(--nc-lk-tx);border:0;border-radius:4px;box-sizing:border-box;cursor:pointer}a button[disabled],button[disabled],input[type=button][disabled],input[type=reset][disabled],input[type=submit][disabled]{cursor:not-allowed;opacity:.5}.button:focus,.button:hover,button:focus,button:hover,input[type=button]:focus,input[type=button]:hover,input[type=reset]:focus,input[type=reset]:hover,input[type=submit]:focus,input[type=submit]:hover{background:var(--nc-lk-2)}code,kbd,pre,samp{font-family:var(--nc-font-mono)}code,kbd,pre,samp{background:var(--nc-bg-2);border:1px solid var(--nc-bg-3);border-radius:4px;padding:3px 6px;font-size:.9rem}kbd{border-bottom:3px solid var(--nc-bg-3)}pre{padding:1rem 1.4rem;max-width:100%;overflow:auto}pre code{background:inherit;font-size:inherit;color:inherit;border:0;padding:0;margin:0}code pre{display:inline;background:inherit;font-size:inherit;color:inherit;border:0;padding:0;margin:0}details{padding:.6rem 1rem;background:var(--nc-bg-2);border:1px solid var(--nc-bg-3);border-radius:4px}summary{cursor:pointer;font-weight:700}details[open]{padding-bottom:.75rem}details[open] summary{margin-bottom:6px}details[open]>:last-child{margin-bottom:0}dt{font-weight:700}dd:before{content:'â†’ '}hr{border:0;border-bottom:1px solid var(--nc-bg-3);margin:1rem auto}fieldset{margin-top:1rem;padding:2rem;border:1px solid var(--nc-bg-3);border-radius:4px}legend{padding:auto .5rem}table{border-collapse:collapse;width:100%}td,th{border:1px solid var(--nc-bg-3);text-align:left;padding:.5rem}th{background:var(--nc-bg-2)}tr:nth-child(even){background:var(--nc-bg-2)}table caption{font-weight:700;margin-bottom:.5rem}textarea{max-width:100%}ol,ul{padding-left:2rem}li{margin-top:.4rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}mark{padding:3px 6px;background:var(--nc-ac-1);color:var(--nc-ac-tx)}input,select,textarea{padding:6px 12px;margin-bottom:.5rem;background:var(--nc-bg-2);color:var(--nc-tx-2);border:1px solid var(--nc-bg-3);border-radius:4px;box-shadow:none;box-sizing:border-box}img{max-width:100%}iframe{border:0;width:100%;height:100%;min-height:300px}</style><style>.center img{max-width:100%;height:auto}pre{color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4}pre code.language-diff span:nth-child(1n + 7){color:#50fa7b}article blockquote p{margin-bottom:0}body table.highlight tr:nth-child(even){background-color:inherit}@media (prefers-color-scheme: dark){.gist-iframe{filter:invert(1) hue-rotate(180deg) brightness(1)}body table.highlight tr:nth-child(even){background-color:#f6f8fa}body table.highlight td,body table.highlight th{border-color:rgba(27,31,35,.3)}}</style><body><main class="container transition-fade" id=swup><div itemscope itemtype=http://schema.org/BlogPosting><div class=container><header class="grid center"><div class="cell menu"><h1 itemprop="name headline">Fastmod Codemod For Refactoring</h1></div></header><p><a title="Go Back Home" href=https://ohdoylerules.com>Go home</a><article class=the-loop><p class=post-info><span class=post-date itemprop=datePublished>ðŸ•’Â Â <span>February 06, 2021</span></span><div itemprop="ArticleBody text" class=main-content><p>If you have ever encounter a big refactor, you were probably dreading the steps it would take to get all the changes done. You have to find patterns, replace them, remove old code, rename variables, so much work! Well, like most things in the development world, there are tools to help you do this. Yes, you can use find-and-replace, but that approach is very naÃ¯ve (as in simple) and doesn't take in some of the more nuanced cases that you will come across.<p>The tool that I have been using for the last couple of years is <a rel="noopener nofollow noreferrer" href=https://github.com/facebookincubator/fastmod target=_blank>fastmod</a>. <code>fastmod</code> is a flavour of <code>codemod</code> but written in Rust - so it has to be cool right? Here is a description from the <code>codemod</code> repo:<blockquote><p>codemod is a tool/library to assist you with large-scale codebase refactors that can be partially automated but still require human oversight and occasional intervention.</blockquote><p>What you do is write a "match pattern" and then a "replace pattern". When you run the tool you get a prompt for each match and you can decide what you want to do with the proposed changes. This is a lot like <code>git add -p</code> (which is also a great trick) where you only accept the changes you know are valid.<p>One of the best things about this tool is how it provides the interface to the changes you need to apply:<ul><li><input checked disabled type=checkbox> filter files by extension<li><input checked disabled type=checkbox> use regex to create matches<li><input checked disabled type=checkbox> named matches so they can be reordered<li><input checked disabled type=checkbox> preview of the changes before you commit them<li><input checked disabled type=checkbox> ability to accept or decline any single change<li><input checked disabled type=checkbox> ability to edit the changes using <code>$EDITOR</code> (like <code>git commit --verbose</code>)<li><input checked disabled type=checkbox> accept all changes without previews ("fast mode")</ul><p><strong>Help With Regex</strong><p>If you are terrible at written regex patterns, you're not alone. There are lots of people who despise regex but it isn't going anyway. I actually made a conscious effort a few years ago to acquire a better understanding of how regex works and what the patterns and special characters do. I used <a rel="noopener nofollow noreferrer" href=https://regexr.com/ target=_blank>this tool call regexr</a> to help practice as well as learn new patterns. Check it out if you need help building and testing regex patterns.<p>Like most purpose-built tools, there is some learning curve to finding how to best use the interface provided. You really need to consider your match strategy and your replace strategy. Let's write some examples based on some real world examples I've come across.<h4 id=css>CSS</h4><p>Here we have a CSS example for a button component. This component can be grouped or have an icon inside it. The naming of the component in CSS is kinda redundant.<pre class=language-css data-lang=css style=background:#2b303b;color:#c0c5ce><code class=language-css data-lang=css><span style=color:#8fa1b3>.</span><span style=color:#d08770>button-group-component </span><span>{
</span><span>  display: flex;
</span><span>  align-items: center;
</span><span>  justify-content: space-between;
</span><span>}
</span><span style=color:#8fa1b3>.</span><span style=color:#d08770>button-component </span><span>{
</span><span>  color: white;
</span><span>  background-color: black;
</span><span>  display: inline-block;
</span><span>  padding: </span><span style=color:#d08770>1rem 2rem</span><span>;
</span><span>}
</span><span style=color:#8fa1b3>.</span><span style=color:#d08770>button-component </span><span style=color:#8fa1b3>.</span><span style=color:#d08770>button-icon-component </span><span style=color:#bf616a>svg </span><span>{
</span><span>  fill: currentColor;
</span><span>}
</span></code></pre><p>Let's remove the <code>-component</code> part of the CSS declaration. We don't need it. So we are going to turn <code>.button-group-component</code> into <code>.button-group</code> and so on for the other 2 class declarations. All we need to do is find <code>-component</code> and replace it with nothing/null/empty string.<pre class=language-sh data-lang=sh style=background:#2b303b;color:#c0c5ce><code class=language-sh data-lang=sh><span style=color:#bf616a>fastmod -m --extensions</span><span> css '</span><span style=color:#a3be8c>(\-component)</span><span>' ''
</span></code></pre><p>Running the above code on in our target folder will prompt us with this:<pre class=language-diff data-lang=diff style=background:#2b303b;color:#c0c5ce><code class=language-diff data-lang=diff><span>./example.css:1
</span><span style=color:#bf616a>- .button-group-component {
</span><span style=color:#a3be8c>+ .button-group {
</span><span>    display: flex;
</span><span>    align-items: center;
</span><span>Accept change (y = yes [default], n = no, e = edit, A = yes to all, E = yes+edit, q = quit)?
</span></code></pre><p>Here you can see all the options for the code that is going to be changed as well as a nice diff too. If we move from left to right in the options we get the following choices:<ul><li><code>y</code> or <code>enter</code> accepts the changes being shown<li><code>n</code> will not change anything and will go to the next change<li><code>e</code> will open your <code>$EDITOR</code> <em>without</em> any changes applied<li><code>A</code> will accept this change and all of the future changes with reprompting you<li><code>E</code> will open your <code>$EDITOR</code> <em>with</em> any changes applied<li><code>q</code> will no accept the changes and stop the process</ul><p>In this case we can hit <code>enter</code> for each change. We will be prompted 4 times: once for each occurrence of the string <code>-component</code> or we can skip all that and just hit <code>A</code> and everything will be changed.<h4 id=webpack-magic-comments>Webpack Magic Comments</h4><p>Recently I was working on a Vue project that had a lot of components in it. I wanted to start using <a rel="noopener nofollow noreferrer" href=https://router.vuejs.org/guide/advanced/lazy-loading.html#grouping-components-in-the-same-chunk target=_blank>webpack chunking</a> in order to split the components up and have single chunks for each component instead of them being wrapped up together. In order to do that, I need to rewrite all my <code>import</code> statements to use "dynamic imports" with a special magic comment that webpack picks up.<p>You can see the example below:<pre class=language-sh data-lang=sh style=background:#2b303b;color:#c0c5ce><code class=language-sh data-lang=sh><span style=color:#65737e># old code: `import MyComponent from 'Components/MyComponent.vue';`
</span><span style=color:#65737e># new code: `const MyComponent = () => import(/* webpackChunkName: "MyComponent" */ 'Components/MyComponent.vue');`
</span><span style=color:#65737e># note: you may need to reorder your imports when using a dynamic import
</span><span>
</span><span style=color:#bf616a>fastmod -m -d</span><span> ./</span><span style=color:#bf616a> --extensions</span><span> vue \
</span><span>  '</span><span style=color:#a3be8c>import (.*?) from \</span><span>'(.*?)</span><span style=color:#96b5b4>\'</span><span>;'</span><span style=color:#a3be8c> \
</span><span style=color:#a3be8c>  </span><span>'</span><span style=color:#bf616a>const </span><span>${</span><span style=color:#bf616a>1</span><span>} = () => import(</span><span style=color:#bf616a>/*</span><span> webpackChunkName: "$</span><span style=color:#a3be8c>{</span><span style=color:#bf616a>1</span><span style=color:#a3be8c>}</span><span>" */ </span><span style=color:#96b5b4>\'</span><span>${</span><span style=color:#bf616a>2</span><span>}</span><span style=color:#96b5b4>\'</span><span>);'
</span></code></pre><p>Here you can see the snippet I wrote to do the refactor. The great thing about using <code>fastmod</code> over find-and-replace, is that it allowed me to accept or deny the changes. I didn't want all the components updated this way. Especially imports that were not Vue components. So this approach was ideal.<h4 id=more-use-cases>More Use Cases</h4><p>Those are two decent examples but I have used this tool quite a lot for refactoring code. Here are some more examples of what I used it for:<ul><li>add/remove classes in HTML<li>rename bad variable names on multiple projects<li>quickly fix the misspelling of various words in multiple projects<li>ran a replace on an exported SQL database backup to change some values in the data (faster than running a query)<li><a rel="noopener nofollow noreferrer" href=https://gist.github.com/james2doyle/a94542b8ef6f07a689f23698424d1763 target=_blank>refactor <code>isset</code> into <code>array_get</code></a> on a Laravel (PHP) project<li>merge down multiple <code>use</code> statement in PHP to a single <code>use</code> line<li>rewrite <code>{{ var }}</code> interpolation to <code>v-text="var"</code> directives in a Vue project<li>replace imports with other versions<li>upgrade old code to new methods or APIs</ul><p>As you can probably already tell, the possibilities are endless! I have used this on database exports and even CSV files. It is a much nicer alternative to find-and-replace. Best of all? It's editor agnostic. So you can use it with any other tools.</div><p><a title="Go Back Home" href=https://ohdoylerules.com>Go home</a><hr><div class="media grid"><div class=media-left><a class=post-author-link href=https://twitter.com/james2doyle target=_blank> <img alt="James Doyle Profile Picture" src="https://www.gravatar.com/avatar/b7375c88e1864c4ddf0d7bdab58e4cca?s=120&d=mm&r=g" height=120 width=120> </a></div><div class="media-body cell -9of12"><div class=media-heading><h3 itemprop="author publisher creator provider">James Doyle</h3></div><div class=media-content><p>I'm a full-stack developer, co-organizer of <a title="PHP Vancouver" href=https://www.meetup.com/vancouver-php target=_blank>PHP Vancouver</a> meetup, and winner of a <a title="Canadian Developer 30 under 30 award" href=http://www.canadianbusiness.com/innovation/developer-30-under-30-gallery/image/20/ target=_blank>Canadian Developer 30 under 30 award</a>. I'm a huge Open Source advocate and contributor to a lot of projects in my community. When I am not sitting at a computer, I'm trying to perfect some other skill.</div></div></div></article></div></div></main><script src=https://unpkg.com/swup@4.6.1/dist/Swup.umd.js></script><script>const swup=new Swup({native:true});function handleGists(){const a=document.querySelectorAll('.iframes');[...a].forEach(function(b){b.onload=function(){b.style.height=b.contentWindow.document.body.scrollHeight+ 50+ 'px'};b.style.height=b.contentWindow.document.body.scrollHeight+ 50+ 'px'})}document.addEventListener('DOMContentLoaded',handleGists);swup.hooks.on('visit:end',handleGists,{priority:100})</script>